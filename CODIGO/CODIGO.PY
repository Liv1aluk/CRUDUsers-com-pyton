import json
import os
from time import sleep
from datetime import datetime


#   CORES PARA TERMINAL (ANSI)

class Cor:
    RESET = '\033[0m'
    VERDE = '\033[92m'
    VERMELHO = '\033[91m'
    AMARELO = '\033[93m'
    AZUL = '\033[94m'
    ROXO = '\033[95m'
    CIANO = '\033[96m'



#   MODELO DE USU√ÅRIO

class Usuario:
    """Representa um usu√°rio com nome, idade e data de cadastro."""

    def __init__(self, nome, idade):
        self.nome = nome.strip().title()
        self.idade = int(idade)
        self.data_cadastro = datetime.now().strftime('%d/%m/%Y %H:%M:%S')

    def to_dict(self):
        return {
            "nome": self.nome,
            "idade": self.idade,
            "data_cadastro": self.data_cadastro
        }



#   GERENCIADOR DE USU√ÅRIOS (BANCO DE DADOS JSON)

class GerenciadorUsuarios:
    """Controla opera√ß√µes de CRUD sobre um arquivo JSON."""

    def __init__(self):
        self.arquivo = os.path.join(os.path.dirname(__file__), 'usuarios.json')
        if not os.path.exists(self.arquivo):
            with open(self.arquivo, 'w') as f:
                json.dump([], f)

    def carregar(self):
        with open(self.arquivo, 'r') as f:
            return json.load(f)

    def salvar(self, dados):
        with open(self.arquivo, 'w') as f:
            json.dump(dados, f, indent=4)

    def adicionar_usuario(self, nome, idade):
        usuarios = self.carregar()
        novo = Usuario(nome, idade).to_dict()
        usuarios.append(novo)
        self.salvar(usuarios)
        print(Cor.VERDE + "‚úî Usu√°rio cadastrado com sucesso!" + Cor.RESET)

    def listar(self):
        usuarios = self.carregar()
        if not usuarios:
            print(Cor.AMARELO + "‚ö† Nenhum usu√°rio cadastrado." + Cor.RESET)
            return

        print(Cor.AZUL + "\n===== LISTA DE USU√ÅRIOS =====" + Cor.RESET)
        for u in usuarios:
            print(f"‚Ä¢ Nome: {u['nome']} | Idade: {u['idade']} | Cadastro: {u['data_cadastro']}")
        print(Cor.AZUL + "=" * 33 + Cor.RESET)

    def buscar(self, nome):
        usuarios = self.carregar()
        encontrados = [u for u in usuarios if nome.lower() in u['nome'].lower()]

        if encontrados:
            print(Cor.ROXO + f"\nüîé Usu√°rios encontrados ({len(encontrados)}):" + Cor.RESET)
            for u in encontrados:
                print(f"‚Ä¢ {u['nome']} ({u['idade']} anos)")
        else:
            print(Cor.VERMELHO + "‚ùå Nenhum usu√°rio encontrado com esse nome." + Cor.RESET)

    def atualizar(self, nome_antigo, novo_nome, nova_idade):
        usuarios = self.carregar()
        for u in usuarios:
            if u['nome'].lower() == nome_antigo.lower():
            #Atualiza
                u['nome'] = novo_nome.strip().title()
                u['idade'] = int(nova_idade)
                u['atualizado_em'] = datetime.now().strftime('%d/%m/%Y %H:%M:%S')
                self.salvar(usuarios)
                print(Cor.VERDE + "‚úî Usu√°rio atualizado!" + Cor.RESET)
                return
        print(Cor.VERMELHO + "‚ùå Usu√°rio n√£o encontrado." + Cor.RESET)

    def excluir(self, nome):
        usuarios = self.carregar()
        novos = [u for u in usuarios if u['nome'].lower() != nome.lower()]

        if len(novos) == len(usuarios):
            print(Cor.VERMELHO + "‚ùå Usu√°rio n√£o encontrado." + Cor.RESET)
            return

        self.salvar(novos)
        print(Cor.AMARELO + "üóë Usu√°rio removido!" + Cor.RESET)

    def total(self):
        qtd = len(self.carregar())
        print(Cor.CIANO + f"\nüìä Total de usu√°rios cadastrados: {qtd}" + Cor.RESET)



#   MENU PRINCIPAL

def menu():
    print(Cor.AZUL + """
===============================
        MENU PRINCIPAL
===============================
1 ‚Äî Adicionar Usu√°rio
2 ‚Äî Listar Usu√°rios
3 ‚Äî Buscar Usu√°rio
4 ‚Äî Atualizar Usu√°rio
5 ‚Äî Excluir Usu√°rio
6 ‚Äî Total de Usu√°rios
7 ‚Äî Sair
""" + Cor.RESET)


def main():
    ger = GerenciadorUsuarios()

    while True:
        menu()
        opcao = input("üëâ Escolha uma op√ß√£o: ")

        if opcao == "1":
            nome = input("Nome: ")
            idade = input("Idade: ")
            ger.adicionar_usuario(nome, idade)

        elif opcao == "2":
            ger.listar()

        elif opcao == "3":
            nome = input("Nome para buscar: ")
            ger.buscar(nome)

        elif opcao == "4":
            antigo = input("Nome a atualizar: ")
            novo = input("Novo nome: ")
            idade = input("Nova idade: ")
            ger.atualizar(antigo, novo, idade)

        elif opcao == "5":
            nome = input("Nome a excluir: ")
            ger.excluir(nome)

        elif opcao == "6":
            ger.total()

        elif opcao == "7":
            print(Cor.AMARELO + "Saindo..." + Cor.RESET)
            sleep(1)
            break

        else:
            print(Cor.VERMELHO + "‚ùå Op√ß√£o inv√°lida!" + Cor.RESET)


if __name__ == "__main__":
    main()
